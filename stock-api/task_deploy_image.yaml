apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: deploy-stock-api-image
spec:
  inputs:
    resources:
      - name: source
        type: git
    params:
      - name: image-name
        description: Name of the image to deploy
        type: string
      - name: context-dir
        description: The context dir of the project containing the Maven pom.xml file
        default: stock-api
      - name: deployment-file
        description: Name of the deployment file to use
        default: deployment.yaml                        
  steps:
    - name: display-image-name
      image: bash:latest
      script: |
        #!/usr/bin/env bash
        echo "Image For Deployment: $(inputs.params.image-name)"
    - name: update-deployment-yaml
      image: alpine
      command: ["sed"]
      args:
        - "-i"
        - "-e"
        - "s;__IMAGE_NAME__;$(inputs.params.image-name);g"
        - "/workspace/source/$(inputs.params.context-dir)/$(inputs.params.deployment-file)"
    - name: run-kubectl
      image: lachlanevenson/k8s-kubectl
      command: ["kubectl"]
      args:
        - "apply"
        - "-f"
        - "/workspace/source/$(inputs.params.context-dir)/$(inputs.params.deployment-file)"        